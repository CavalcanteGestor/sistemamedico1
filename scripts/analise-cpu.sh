#!/bin/bash

# Script de Anรกlise Detalhada de CPU
# Gera relatรณrio formatado para anรกlise

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ     ๐ ANรLISE DETALHADA DE CPU - Sistema Lumi                โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ Data/Hora: $(date '+%d/%m/%Y %H:%M:%S')"
echo "๐ฅ๏ธ  Hostname: $(hostname)"
echo ""

# ============================================
# 1. USO GERAL DE CPU
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 1๏ธโฃ  USO GERAL DE CPU                                            โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

CPU_IDLE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/")
CPU_USAGE=$(echo "100 - $CPU_IDLE" | bc -l | awk '{printf "%.1f", $1}')

# Cores baseados no uso
if (( $(echo "$CPU_USAGE > 90" | bc -l) )); then
    CPU_COLOR="๐ด"
    CPU_STATUS="CRรTICO"
elif (( $(echo "$CPU_USAGE > 70" | bc -l) )); then
    CPU_COLOR="๐ก"
    CPU_STATUS="ALTO"
elif (( $(echo "$CPU_USAGE > 50" | bc -l) )); then
    CPU_COLOR="๐"
    CPU_STATUS="MODERADO"
else
    CPU_COLOR="๐ข"
    CPU_STATUS="NORMAL"
fi

echo "$CPU_COLOR CPU Total: ${CPU_USAGE}% ($CPU_STATUS)"
echo "   CPU Idle: ${CPU_IDLE}%"
echo ""

# Detalhes por core (se disponรญvel)
if command -v mpstat &> /dev/null; then
    echo "   Detalhes por Core:"
    mpstat -P ALL 1 1 | tail -n +4 | awk '{printf "   Core %s: %.1f%%\n", $2, 100-$NF}'
    echo ""
fi

# ============================================
# 2. TOP 15 PROCESSOS CONSUMINDO CPU
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 2๏ธโฃ  TOP 15 PROCESSOS CONSUMINDO CPU                           โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
printf "%-8s %-8s %8s %8s %8s %s\n" "USER" "PID" "CPU%" "MEM%" "VSZ(MB)" "COMANDO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

ps aux --sort=-%cpu | head -16 | tail -15 | awk '{
    vsz_mb = $5 / 1024
    printf "%-8s %-8s %7.1f%% %7.1f%% %8.1f %s\n", $1, $2, $3, $4, vsz_mb, $11
}'
echo ""

# ============================================
# 3. PROCESSOS NODE.JS
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 3๏ธโฃ  PROCESSOS NODE.JS (Detalhado)                            โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

NODE_PROCS=$(ps aux | grep -E "node|n8n|next" | grep -v grep)

if [ -z "$NODE_PROCS" ]; then
    echo "   โ๏ธ  Nenhum processo Node.js encontrado"
else
    echo "   Processos Node.js encontrados:"
    echo ""
    printf "%-8s %8s %8s %8s %s\n" "PID" "CPU%" "MEM%" "VSZ(MB)" "COMANDO"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "$NODE_PROCS" | awk '{
        vsz_mb = $5 / 1024
        cmd = ""
        for(i=11; i<=NF; i++) cmd = cmd " " $i
        printf "%-8s %7.1f%% %7.1f%% %8.1f %s\n", $2, $3, $4, vsz_mb, cmd
    }'
fi
echo ""

# ============================================
# 4. PROCESSOS PM2
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 4๏ธโฃ  STATUS PM2                                                 โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if command -v pm2 &> /dev/null; then
    PM2_LIST=$(pm2 jlist 2>/dev/null)
    if [ -n "$PM2_LIST" ] && [ "$PM2_LIST" != "[]" ]; then
        echo "$PM2_LIST" | jq -r '.[] | "   ๐ฆ \(.name):\n      Status: \(.pm2_env.status)\n      CPU: \(.monit.cpu)%\n      RAM: \(.monit.memory/1024/1024 | floor)MB\n      Uptime: \(.pm2_env.pm_uptime | strftime("%Hh %Mm"))\n      Restarts: \(.pm2_env.restart_time)\n"' 2>/dev/null || pm2 list
    else
        echo "   โ๏ธ  Nenhum processo PM2 rodando"
        pm2 list
    fi
else
    echo "   โ๏ธ  PM2 nรฃo estรก instalado"
fi
echo ""

# ============================================
# 5. USO DE MEMรRIA
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 5๏ธโฃ  USO DE MEMรRIA                                             โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

free -h | awk '
NR==1 {print "   " $0}
NR==2 {
    total=$2
    used=$3
    free=$4
    shared=$5
    buff_cache=$6
    available=$7
    
    used_pct = (used/total)*100
    available_pct = (available/total)*100
    
    printf "   Mem:    %s total, %s usada (%.1f%%), %s livre, %s disponรญvel (%.1f%%)\n", 
           total, used, used_pct, free, available, available_pct
}
NR==3 {
    printf "   Swap:   %s total, %s usada, %s livre\n", $2, $3, $4
}'
echo ""

# ============================================
# 6. TOP 10 PROCESSOS POR MEMรRIA
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 6๏ธโฃ  TOP 10 PROCESSOS CONSUMINDO MEMรRIA                      โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
printf "%-8s %-8s %8s %8s %8s %s\n" "USER" "PID" "CPU%" "MEM%" "VSZ(MB)" "COMANDO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

ps aux --sort=-%mem | head -11 | tail -10 | awk '{
    vsz_mb = $5 / 1024
    printf "%-8s %-8s %7.1f%% %7.1f%% %8.1f %s\n", $1, $2, $3, $4, vsz_mb, $11
}'
echo ""

# ============================================
# 7. LOAD AVERAGE
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 7๏ธโฃ  LOAD AVERAGE                                               โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

LOAD=$(uptime | awk -F'load average:' '{print $2}')
CPU_CORES=$(nproc)
echo "   Load Average:$LOAD"
echo "   CPU Cores: $CPU_CORES"
echo ""

# Calcular se load estรก alto
LOAD_1MIN=$(echo $LOAD | awk '{print $1}' | sed 's/,//')
LOAD_THRESHOLD=$(echo "$CPU_CORES * 0.7" | bc -l)

if (( $(echo "$LOAD_1MIN > $LOAD_THRESHOLD" | bc -l) )); then
    echo "   โ๏ธ  Load Average estรก ALTO (acima de 70% dos cores)"
else
    echo "   โ Load Average estรก normal"
fi
echo ""

# ============================================
# 8. PORTAS EM USO
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 8๏ธโฃ  PORTAS EM USO (Node.js)                                   โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

NETSTAT=$(netstat -tulpn 2>/dev/null | grep LISTEN | grep -E "node|n8n|next" || ss -tulpn 2>/dev/null | grep LISTEN | grep -E "node|n8n|next")

if [ -n "$NETSTAT" ]; then
    echo "$NETSTAT" | awk '{printf "   Porta %s: %s\n", $4, $7}' | head -10
else
    echo "   โ๏ธ  Nenhuma porta Node.js encontrada"
fi
echo ""

# ============================================
# 9. RECOMENDAรรES
# ============================================
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ 9๏ธโฃ  RECOMENDAรรES                                              โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if (( $(echo "$CPU_USAGE > 90" | bc -l) )); then
    echo "   ๐ด CRรTICO: CPU acima de 90%"
    echo ""
    echo "   Aรงรตes imediatas:"
    echo "   1. Identifique o processo com maior CPU% (seรงรฃo 2)"
    echo "   2. Se for n8n: pm2 restart n8n"
    echo "   3. Se for processo รณrfรฃo: kill -9 <PID>"
    echo "   4. Verifique workflows do n8n em loop"
    echo "   5. Considere limitar recursos no PM2"
    echo ""
elif (( $(echo "$CPU_USAGE > 70" | bc -l) )); then
    echo "   ๐ก ATENรรO: CPU acima de 70%"
    echo ""
    echo "   Aรงรตes recomendadas:"
    echo "   1. Monitore processos na seรงรฃo 2"
    echo "   2. Verifique se hรก processos duplicados"
    echo "   3. Otimize workflows do n8n"
    echo "   4. Configure limites de recursos no PM2"
    echo ""
else
    echo "   ๐ข CPU em nรญveis aceitรกveis"
    echo ""
    echo "   Sistema estรก funcionando normalmente."
    echo "   Pode adicionar novos sistemas com seguranรงa."
    echo ""
fi

# Verificar processos duplicados
DUPLICATES=$(ps aux | grep -E "node|n8n|next" | grep -v grep | awk '{print $11}' | sort | uniq -d)
if [ -n "$DUPLICATES" ]; then
    echo "   โ๏ธ  ATENรรO: Possรญveis processos duplicados detectados"
    echo "   Verifique processos Node.js na seรงรฃo 3"
    echo ""
fi

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ โ Anรกlise concluรญda                                           โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ก Dica: Copie este relatรณrio completo ou faรงa print para anรกlise"
echo ""

