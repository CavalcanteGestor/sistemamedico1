#!/bin/bash

# Script Simples de Anรกlise de CPU
# Versรฃo mais compacta para print rรกpido

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ANรLISE RรPIDA DE CPU - $(date '+%d/%m/%Y %H:%M:%S')"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# CPU Usage
CPU_IDLE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/")
CPU_USAGE=$(echo "100 - $CPU_IDLE" | bc -l | awk '{printf "%.1f", $1}')

if (( $(echo "$CPU_USAGE > 90" | bc -l) )); then
    echo "๐ด CPU: ${CPU_USAGE}% (CRรTICO!)"
elif (( $(echo "$CPU_USAGE > 70" | bc -l) )); then
    echo "๐ก CPU: ${CPU_USAGE}% (ALTO)"
else
    echo "๐ข CPU: ${CPU_USAGE}% (OK)"
fi
echo ""

# Top 10 processos
echo "TOP 10 PROCESSOS POR CPU:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
printf "%-8s %8s %8s %s\n" "PID" "CPU%" "MEM%" "COMANDO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
ps aux --sort=-%cpu | head -11 | tail -10 | awk '{
    cmd = ""
    for(i=11; i<=NF; i++) cmd = cmd " " $i
    printf "%-8s %7.1f%% %7.1f%% %s\n", $2, $3, $4, cmd
}'
echo ""

# Processos Node.js
echo "PROCESSOS NODE.JS:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
NODE_PROCS=$(ps aux | grep -E "node|n8n|next" | grep -v grep)
if [ -n "$NODE_PROCS" ]; then
    echo "$NODE_PROCS" | awk '{
        cmd = ""
        for(i=11; i<=NF; i++) cmd = cmd " " $i
        printf "PID: %-8s CPU: %6.1f%% MEM: %6.1f%% %s\n", $2, $3, $4, cmd
    }'
else
    echo "Nenhum processo Node.js encontrado"
fi
echo ""

# PM2 Status
if command -v pm2 &> /dev/null; then
    echo "STATUS PM2:"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    pm2 list
    echo ""
fi

# Memรณria
echo "MEMรRIA:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
free -h | grep Mem | awk '{printf "Total: %s | Usada: %s (%.1f%%) | Livre: %s\n", $2, $3, ($3/$2)*100, $4}'
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

